services:
  backend:
    restart: unless-stopped
    build:
      dockerfile: ./Dockerfile
      context: ./api/
    env_file: ./api/.env.production
    networks: # isolate all networks so an attacker cannot escalate
      - db_link
      - s3_link
      - redis_link
      - external
    depends_on:
      - redis
      - postgresql
      - minio
    labels:
      # Enable Traefik for this service
      - traefik.enable=true
      - traefik.docker.network=traefik
      # Define a router for the API on a subdomain
      - traefik.http.routers.etherbeing_backend.rule=Host(`etherbeing.cd.godjango.dev`)
      - traefik.http.routers.etherbeing_backend.entrypoints=web,websecure
      # Define the service to hit port 8080 inside the container
      - traefik.http.services.etherbeing_backend.loadbalancer.server.port=8080
  frontend:
    restart: unless-stopped
    build:
      dockerfile: ./Dockerfile
      context: ./web/
    env_file: ./web/.env
    labels:
      # Enable Traefik for this service
      - traefik.enable=true
      - traefik.docker.network=traefik
      # Define a router for the main domain
      - traefik.http.routers.etherbeing_frontend.rule=Host(`www.etherbeing.cd.godjango.dev`)
      - traefik.http.routers.etherbeing_frontend.entrypoints=web,websecure
      - traefik.http.services.etherbeing_minio.loadbalancer.passHostHeader=true
      # Define the service to hit port 80 inside the container
      - traefik.http.services.etherbeing_frontend.loadbalancer.server.port=3000
    networks:
      - external
  redis:
    image: redis:latest
    env_file: ./.env.redis
    restart: unless-stopped
    volumes:
      - redis_storage:/data/
    networks:
      - redis_link
  postgresql:
    image: postgres:latest
    restart: unless-stopped
    # set shared memory limit when using docker compose
    shm_size: 128mb
    env_file: ./.env.postgres
    volumes: 
      - postgres_storage:/var/lib/postgresql/data
    networks:
      - db_link
      - oauth_link
  minio:
    image: quay.io/minio/minio:latest
    restart: unless-stopped
    env_file: ./.env.s3
    volumes:
      - s3_storage:/data
    ports:
      - 9000:9000
      - 9001:9001
    command: server /data --console-address ":9001"
    networks:
      - s3_link
      - external
    labels:
      # Enable Traefik for MinIO Console UI (Port 9001)
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.etherbeing_minio.rule=Host(`s3.etherbeing.cd.godjango.dev`)
      - traefik.http.routers.etherbeing_minio.entrypoints=web,websecure
      - traefik.http.services.etherbeing_minio.loadbalancer.passHostHeader=true
      # Route to the console port (9001)
      - traefik.http.services.etherbeing_minio.loadbalancer.server.port=9001
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    env_file: ./.env.oauth
    command: start-dev
    depends_on:
      - postgresql
    networks:
      - oauth_link
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.etherbeing_oauth.rule=Host(`oauth.etherbeing.cd.godjango.dev`)
      - traefik.http.routers.etherbeing_oauth.entrypoints=web,websecure
      - traefik.http.services.etherbeing_oauth.loadbalancer.passHostHeader=true
      - traefik.http.services.etherbeing_oauth.loadbalancer.server.port=8080
networks:
  default:
  db_link:
  s3_link:
  redis_link:
  oauth_link:
  external: # Set external to false in case you don't need this for example you aren't using traefik
    external: true
    name: traefik
volumes:
  s3_storage:
  postgres_storage:
  redis_storage:
